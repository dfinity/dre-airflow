default:
  image: registry.gitlab.com/dfinity-lab/core/release/ci-build@sha256:a74ec89d678e1f1d5473e3a6862f5ffd56f45c2fdc4d1d7f93a13e7afb53ef31
  tags:
    # Use the DFINITY CI runners (they have following tags)
    - dfinity-shared
    - ubuntu
  # Retry config copied from:
  # https://gitlab.com/gitlab-org/gitlab/blob/master/.gitlab/ci/global.gitlab-ci.yml#L1-9
  # Complete description available at:
  # https://docs.gitlab.com/ee/ci/yaml/#retry
  retry:
    max: 2 # This is confusing but this means "3 runs at max".
    when:
      - unknown_failure
      - api_failure
      - runner_system_failure

stages:
  - release

variables:
  APP: airflow-content-syncer
  CONTEXT_PATH: airflow-content-syncer
  DOCKERFILE_PATH: airflow-content-syncer/Dockerfile

release:
  tags:
    - ubuntu
    - dfinity-shared
  image:
    name: gcr.io/kaniko-project/executor:debug # debug is required for gitlab as it needs to run a shell inside.
    entrypoint: [""]
  variables:
    APP: content-syncer
  script:
    - "[[ -z ${APP+x} ]] && echo 'APP is not defined' && exit 1"
    - "[[ -z ${CONTEXT_PATH+x} ]] && echo 'CONTEXT_PATH is not defined' && exit 1"
    - "[[ -z ${DOCKERFILE_PATH+x} ]] && echo 'DOCKERFILE_PATH is not defined' && exit 1"
    - |
      if [ "${CI_COMMIT_BRANCH}" != "${CI_DEFAULT_BRANCH}" ]; then
        export KANIKO_NO_PUSH_FLAG="--no-push"
      else
        export KANIKO_NO_PUSH_FLAG=""
      fi
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/${CONTEXT_PATH}"
      --dockerfile "${DOCKERFILE_PATH}"
      --cache
      --cache-repo "${CI_REGISTRY_IMAGE}/${APP}/cache"
      --destination "${CI_REGISTRY_IMAGE}/${APP}:latest"
      --destination "${CI_REGISTRY_IMAGE}/${APP}:${CI_COMMIT_SHA}"
      --snapshotMode=redo
      --reproducible
      $KANIKO_NO_PUSH_FLAG
    - mkdir -p /workspace # Fails without creating this folder due to https://gitlab.com/gitlab-org/gitlab-runner/-/issues/29587/
